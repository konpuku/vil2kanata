# vil2kanata

Vial (.vil) の設定ファイルを Kanata (.kbd) の設定ファイルに変換する CLI ツール。

外付けキーボード (Vial対応) の設定を、ソフトウェアキーリマッパー [Kanata](https://github.com/jtroo/kanata) に移植する用途を想定しています。Node.js 単体で動作し、外部依存はありません。

## はじめに（セットアップから変換まで）

CLI (コマンドライン) の操作に慣れていない方向けに、手順をひとつずつ説明します。

### 1. Node.js をインストールする

このツールの実行には **Node.js** が必要です。まだインストールしていない場合は、以下からダウンロードしてインストールしてください。

https://nodejs.org/

「LTS（推奨版）」をダウンロードすれば問題ありません。インストーラーの選択肢はすべてデフォルトのままで大丈夫です。

### 2. このツールをダウンロードする

以下のどちらかの方法でファイルを入手してください。

**方法 A: ZIP でダウンロード（簡単）**

1. このページの上部にある緑色の **「Code」** ボタンをクリック
2. **「Download ZIP」** をクリック
3. ダウンロードした ZIP を好きな場所に展開する

**方法 B: git でクローン**

```bash
git clone https://github.com/konpuku/vil2kanata.git
```

### 3. Vial から .vil ファイルをエクスポートする

1. **Vial** アプリを開く
2. メニューから **File → Save current layout...** を選択
3. ファイル名を付けて保存する（例: `my_keyboard.vil`）

### 4. ターミナル（コマンドプロンプト）を開く

**Windows の場合:**

- `Win + R` キーを押して「ファイル名を指定して実行」を開く
- `cmd` と入力して Enter

または

- エクスプローラーで vil2kanata フォルダを開く
- アドレスバーに `cmd` と入力して Enter（そのフォルダでコマンドプロンプトが開きます）

**Mac の場合:**

- Spotlight (`Cmd + Space`) で「ターミナル」と検索して開く

### 5. vil2kanata のフォルダに移動する

ターミナルに以下のように入力します。パスは実際に展開した場所に置き換えてください。

```bash
cd C:\Users\あなたのユーザー名\Downloads\vil2kanata
```

> **ヒント:** フォルダのパスがわからない場合は、エクスプローラーでフォルダを開き、アドレスバーのパスをコピーしてください。

### 6. 変換を実行する

.vil ファイルのパスを指定して実行します。

```bash
node vil2kanata.js C:\Users\あなたのユーザー名\Desktop\my_keyboard.vil --output my_keyboard.kbd
```

変換が成功すると、以下のメッセージが表示されます。

```
変換完了: my_keyboard.kbd
```

生成された `my_keyboard.kbd` をテキストエディタで開いて内容を確認してください。

> **ヒント:** `--output` を省略すると、変換結果が画面にそのまま表示されます。内容を確認したいだけのときに便利です。
>
> ```bash
> node vil2kanata.js my_keyboard.vil
> ```

### 7. 出力ファイルを調整する

変換結果は **そのままでは Kanata で動作しません**。テキストエディタで `.kbd` ファイルを開き、[出力後の手動調整](#出力後の手動調整) セクションを参考に修正してください。

### うまくいかないときは

| 症状 | 対処 |
|---|---|
| `'node' は...認識されていません` | Node.js がインストールされていないか、パスが通っていません。Node.js を再インストールしてください。 |
| `エラー: ファイルの読み込みに失敗しました` | .vil ファイルのパスが間違っています。ファイルが存在するか確認してください。パスにスペースが含まれる場合は `"` で囲んでください（例: `"C:\My Files\kb.vil"`）。 |
| `エラー: JSONパースに失敗しました` | .vil ファイルが壊れている可能性があります。Vial から再度エクスポートしてください。 |
| `エラー: layoutデータが空です` | .vil ファイルにキーマップが含まれていません。Vial でキーマップを設定してからエクスポートしてください。 |

## 使い方（リファレンス）

```bash
node vil2kanata.js <input.vil> [--output output.kbd]
```

| オプション | 説明 |
|---|---|
| `<input.vil>` | 変換元の Vial 設定ファイル（必須） |
| `--output`, `-o` | 出力先のファイルパス。省略時は標準出力に出力 |
| `--help`, `-h` | ヘルプを表示 |

## 変換対象

| Vial (.vil) | Kanata (.kbd) |
|---|---|
| 基本キーコード (`KC_A` など) | Kanata キー名 (`a`) |
| Mod-Tap (`LGUI_T(KC_A)`) | `(tap-hold-release 200 200 a lmet)` |
| Layer-Tap (`LT1(KC_BSPACE)`) | `(tap-hold-release 200 200 bspc (layer-toggle layer1))` |
| 修飾付きキー (`LSFT(KC_8)`) | `S-8` |
| レイヤー操作 (`MO(n)`, `TO(n)` 等) | `(layer-toggle ...)` / `(layer-switch ...)` |
| マクロ | `(macro ...)` (down/tap/up パターンを自動最適化) |
| タップダンス | `(tap-dance ...)` + `(tap-hold-release ...)` |
| コンボ | `(defchordsv2 ...)` |
| キーオーバーライド | コメントとして出力 (Kanata に直接対応なし) |
| マウスキー | `(movemouse-* 1 1)`, `mlft`, `mrgt` |
| 日本語キー (`KC_RO`, `KC_LANG1` 等) | `ro`, `kana`, `eisu` 等 |

## 出力後の手動調整

変換結果はそのままでは動作しません。以下の調整が必要です。

### defsrc の書き換え

`defsrc` はベースレイヤーのキー名から自動生成されますが、実際の物理キーボードのレイアウトに合わせて書き換える必要があります。特にノート PC の JIS キーボードに合わせる場合、キーの数や配置が異なります。

重複キーがある場合は警告コメントが出力されます。

### USER キーコード

`USER01` 等のユーザー定義キーコードはプレースホルダー (`f14` 等) に変換されます。実際のキーに置き換えてください。

### キーオーバーライド

QMK の Key Override 機能は Kanata に直接対応する機能がないため、コメントとして元の設定が出力されます。必要に応じて `fork` や `switch` で実装してください。

## 動作確認済み環境

- Vial Protocol v6 / VIA Protocol v9
- Bancouver40 (4x10, 5 レイヤー)

## ライセンス

MIT
