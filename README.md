# vil2kanata

Vial (.vil) の設定ファイルを Kanata (.kbd) の設定ファイルに変換するツール。CLI とブラウザ GUI の2つのモードで利用できます。

外付けキーボード (Vial対応) の設定を、ソフトウェアキーリマッパー [Kanata](https://github.com/jtroo/kanata) に移植する用途を想定しています。

---

## GUI エディタ (推奨)

ブラウザ上で動作するビジュアルキーマップエディタです。ノート PC のキーボード上で、Kanata の設定ファイル (.kbd) をゼロから作成できます。Vial (.vil) のインポートにも対応しています。

### 起動方法

`gui/index.html` をブラウザで直接開くだけで使えます。インストールやビルドは不要です。

```
gui/index.html をダブルクリック、またはブラウザにドラッグ&ドロップ
```

### 画面構成

```
┌─────────────────────────────────────────────────┐
│ vil2kanata GUI          [.kbdエクスポート] [保存] [読込] │
├──────┬──────────────────────────────────────────┤
│      │  キーボードビジュアライザ                          │
│  左  │  (物理配列 + VILソース配列)                      │
│  パ  │                                                │
│  ネ  ├──────────────────────────────────────────┤
│  ル  │  [src] [base] [layer1] [layer2] ... [+]       │
│      ├──────────────────────────────────────────┤
│      │  [キー設定] [マクロ] [タップダンス] [コンボ] [オーバーライド]│
│      ├──────────────────────────────────────────┤
│      │  エディタ / 機能パネル                            │
│      ├──────────────────────────────────────────┤
│      │  設定バー (tap-time, hold-time, defcfg)         │
└──────┴──────────────────────────────────────────┘
```

### 基本的なワークフロー

#### 1. ベースレイアウトを選ぶ

左パネルのドロップダウンから物理キーボードのレイアウトを選択します。

| プリセット | 対象 |
|-----------|------|
| US ANSI 60% | 60% キーボード (US配列) |
| US ANSI Fn Row | ファンクションキー行あり |
| US ANSI TKL | テンキーレス |
| JIS 60% | 60% キーボード (JIS配列) |

#### 2. src タブで物理キーを設定する

レイヤータブの先頭にある **src** タブが物理キーの定義 (defsrc) です。

- クリックでキーを選択 → 右側エディタで物理キー名を変更
- ノート PC のキーボードに合わせてキーの追加・削除ができます
- 右クリックでキーを削除

#### 3. base / layer タブでキーマップを設定する

base タブ以降が各レイヤーのキーマップです。

- キーをクリックして選択
- **キー設定** パネルでキーの種類を選択:

| 種類 | 説明 | 例 |
|------|------|----|
| 基本キー | 単一キー | `A`, `Enter`, `Space` |
| 修飾付き | Shift/Ctrl等 + キー | `S-9` → `(` |
| Mod-Tap | タップとホールドで別の動作 | タップ: `A` / ホールド: `LCtrl` |
| Layer-Tap | タップでキー、ホールドでレイヤー切替 | タップ: `Space` / ホールド: `layer1` |
| レイヤー操作 | レイヤー切替 | `MO(1)`, `TO(2)` |
| マクロ | マクロ呼び出し | `M0`, `M1` |
| タップダンス | タップダンス呼び出し | `TD0`, `TD1` |
| 透過 | 下位レイヤーのキーを引き継ぐ | `▽` |

- 各キーの右下に薄く表示されるサブラベルが、物理キー名 (src) です
- ドラッグ&ドロップでキーの位置を入れ替えられます

#### 4. 機能を追加する

キー設定タブの隣にある各タブで、追加機能を設定できます。

**マクロ** — キーの連続入力やテキスト入力を自動化
- タップ (単一キー送信)、テキスト (文字列入力)、ディレイ (待機) を組み合わせ

**タップダンス** — タップ回数で異なるキーを発動
- 例: 1回タップ → `a`、2回タップ → `Esc`

**コンボ** — 複数キーの同時押しで別のキーを発動
- トリガーキーは base レイヤーの設定で表示されます
- エクスポート時に自動的に物理キー (defsrc) に変換されます
- 例: `無変換` + `変換` 同時押し → `IME OFF`

**オーバーライド** — 特定のキー + 修飾キーの組み合わせを別のキーに置換

#### 5. エクスポート

ヘッダーの **「.kbd エクスポート」** ボタンで Kanata 設定ファイルをダウンロードできます。

### Windows での IME 制御

日本語 IME の ON/OFF には、キーピッカーから以下を選択してください。

| キー名 | 機能 | 出力 |
|--------|------|------|
| `lang1` | IME ON | `(arbitrary-code 242)` VK_DBE_HIRAGANA |
| `lang2` | IME OFF | `(arbitrary-code 26)` VK_IME_OFF |

`kana` キーは Windows では韓国語 IME (VK_KANA) にマッピングされるため、日本語 IME の切替には使えません。

### プロジェクトの保存と読込

- **保存**: 現在の設定を JSON ファイルとして保存
- **読込**: 保存した JSON ファイルを読み込んで編集を再開

### .vil ファイルのインポート

左パネルの **「.vil インポート」** ボタンで、Vial からエクスポートした .vil ファイルを読み込めます。VIL のキーマップがインポートされ、ソース配列がキーボード右側に表示されます。

### キー表示モード

左パネルの **US / JIS** ボタンで、キーラベルの表示を切り替えられます。

| モード | 表示例 |
|--------|--------|
| US | `[` `]` `\` `;` `'` `` ` `` |
| JIS | `@` `[` `]` `:` `*` `半/全` |

### 色覚異常対応 (Color Universal Design)

キータイプの識別に色だけでなくボーダー形状も使用しています。

| キータイプ | 色 | ボーダー |
|-----------|-----|---------|
| レイヤー操作 | 紫系 | 左に太線 |
| マクロ | 緑青 | 上に太線 |
| タップダンス | オレンジ茶 | 点線 |
| Mod-Tap / Layer-Tap | 青系 | (上下分割表示) |

---

## CLI (コマンドライン)

.vil ファイルを直接 .kbd に変換する Node.js スクリプトです。

### 必要なもの

- [Node.js](https://nodejs.org/) (LTS 推奨)

### 使い方

```bash
node vil2kanata.js <input.vil> [--output output.kbd]
```

| オプション | 説明 |
|---|---|
| `<input.vil>` | 変換元の Vial 設定ファイル (必須) |
| `--output`, `-o` | 出力先のファイルパス。省略時は標準出力 |
| `--help`, `-h` | ヘルプを表示 |

### CLI での出力後の手動調整

CLI による変換結果はそのままでは動作しない場合があります。

- **defsrc の書き換え**: ベースレイヤーのキー名から自動生成されますが、物理キーボードに合わせて修正が必要です
- **USER キーコード**: `USER01` 等はプレースホルダー (`f14` 等) に変換されます
- **キーオーバーライド**: QMK の Key Override は Kanata に直接対応がないため、コメントとして出力されます

> CLI での手動調整が面倒な場合は、GUI エディタの使用を推奨します。

---

## 変換対象

| Vial (.vil) | Kanata (.kbd) |
|---|---|
| 基本キーコード (`KC_A` 等) | Kanata キー名 (`a`) |
| Mod-Tap (`LGUI_T(KC_A)`) | `(tap-hold-release 200 200 a lmet)` |
| Layer-Tap (`LT1(KC_BSPACE)`) | `(tap-hold-release 200 200 bspc (layer-toggle layer1))` |
| 修飾付きキー (`LSFT(KC_8)`) | `S-8` |
| レイヤー操作 (`MO(n)`, `TO(n)` 等) | `(layer-toggle ...)` / `(layer-switch ...)` |
| マクロ | `(macro ...)` |
| タップダンス | `(tap-dance ...)` |
| コンボ | `(defchordsv2 ...)` |
| キーオーバーライド | `(defoverrides ...)` (GUI) / コメント (CLI) |
| マウスキー | `mlft`, `mrgt`, `mmid` 等 |
| 日本語キー | `ro`, `kana`, `mhnk`, `henk` 等 |
| IME ON/OFF (Windows) | `(arbitrary-code 242)` / `(arbitrary-code 26)` |

## 動作確認済み環境

- Vial Protocol v6 / VIA Protocol v9
- Kanata v1.10.1
- Windows 11
- Chrome / Edge (GUI)

## ライセンス

MIT
